<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>02_Data_Processing - sds-3.x/ScaDaMaLe</title>


        <!-- Custom HTML head -->

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../scroll-mdbook-outputs.css">

        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../contents/student-project-09_group-TopicModeling/01_Introduction.html">01_Introduction</a></li><li class="chapter-item expanded affix "><a href="../../contents/student-project-09_group-TopicModeling/02_Data_Processing.html" class="active">02_Data_Processing</a></li><li class="chapter-item expanded affix "><a href="../../contents/student-project-09_group-TopicModeling/03_LDA.html">03_LDA</a></li><li class="chapter-item expanded affix "><a href="../../contents/student-project-09_group-TopicModeling/04_Classification_CountVector.html">04_Classification_CountVector</a></li><li class="chapter-item expanded affix "><a href="../../contents/student-project-09_group-TopicModeling/05_Classification.html">05_Classification</a></li><li class="chapter-item expanded affix "><a href="../../contents/student-project-09_group-TopicModeling/06_Results.html">06_Results</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">sds-3.x/ScaDaMaLe</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <div class="cell markdown">
<p>ScaDaMaLe Course <a href="https://lamastex.github.io/scalable-data-science/sds/3/x/">site</a> and <a href="https://lamastex.github.io/ScaDaMaLe/index.html">book</a></p>
</div>
<div class="cell markdown">
<h1 id="data-processing"><a class="header" href="#data-processing">Data Processing</a></h1>
</div>
<div class="cell markdown">
<h3 id="load-datasets"><a class="header" href="#load-datasets">Load datasets</a></h3>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">// Paths to datasets of different regions.
val paths: List[String] = List(&quot;dbfs:/FileStore/shared_uploads/hugower@kth.se/sequences_oceania.fasta&quot;,
                               &quot;dbfs:/FileStore/shared_uploads/hugower@kth.se/sequences_northamerica.fasta&quot;,
                               &quot;dbfs:/FileStore/shared_uploads/hugower@kth.se/sequences_southamerica.fasta&quot;,
                               &quot;dbfs:/FileStore/shared_uploads/hugower@kth.se/sequences_europe.fasta&quot;,
                               &quot;dbfs:/FileStore/shared_uploads/hugower@kth.se/sequences_africa.fasta&quot;,
                               &quot;dbfs:/FileStore/shared_uploads/hugower@kth.se/sequences_asia.fasta&quot;)
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>paths: List[String] = List(dbfs:/FileStore/shared_uploads/hugower@kth.se/sequences_oceania.fasta, dbfs:/FileStore/shared_uploads/hugower@kth.se/sequences_northamerica.fasta, dbfs:/FileStore/shared_uploads/hugower@kth.se/sequences_southamerica.fasta, dbfs:/FileStore/shared_uploads/hugower@kth.se/sequences_europe.fasta, dbfs:/FileStore/shared_uploads/hugower@kth.se/sequences_africa.fasta, dbfs:/FileStore/shared_uploads/hugower@kth.se/sequences_asia.fasta)
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">import scala.util.matching.Regex

// regex pattern to take region name, label, from complete path name (Must be changed accordingly if path follows a different structure)
val pattern: Regex = &quot;/[a-zA-Z]+_([a-zA-Z]+)\\.&quot;.r 

def read_datasets(paths:List[String]): List[RDD[(String,String)]] = {
  if (paths.size &lt; 1) { // return an empty RDD
    return List.fill(0) (sc.emptyRDD)
  }
  else {
    pattern.findFirstMatchIn(paths.head) match { // extract the label based on the pattern defined above
      case Some(x) =&gt; {
        val label:String = x.group(1)  // create the label based on the path name
        return (sc.textFile(paths.head).filter(_ != &quot;&quot;).map(_.trim()).map(s =&gt; (s,label)))::read_datasets(paths.tail) // read the file in path and attach the data with its label to RDD list
      }
      case None =&gt; throw new RuntimeException(&quot;no label found&quot;)
    }
  }
}
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>import scala.util.matching.Regex
pattern: scala.util.matching.Regex = /[a-zA-Z]+_([a-zA-Z]+)\.
read_datasets: (paths: List[String])List[org.apache.spark.rdd.RDD[(String, String)]]
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">// read data and set the delimiter as &quot;&gt;&quot; which seperates each sample in fasta format
sc.hadoopConfiguration.set(&quot;textinputformat.record.delimiter&quot;,&quot;&gt;&quot;)
val datasets = read_datasets(paths)
  
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>datasets: List[org.apache.spark.rdd.RDD[(String, String)]] = List(MapPartitionsRDD[202189] at map at command-3103574048361361:13, MapPartitionsRDD[202196] at map at command-3103574048361361:13, MapPartitionsRDD[202205] at map at command-3103574048361361:13, MapPartitionsRDD[202210] at map at command-3103574048361361:13, MapPartitionsRDD[202215] at map at command-3103574048361361:13, MapPartitionsRDD[202220] at map at command-3103574048361361:13)
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">datasets.length
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>res0: Int = 6
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">datasets(0).take(1)
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">// combine the datasets into one and cache for optimization
val data = datasets.reduce( (a,b) =&gt; a++b).cache()
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>data: org.apache.spark.rdd.RDD[(String, String)] = UnionRDD[202273] at $plus$plus at command-3103574048361373:1
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">data.take(1)
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">// get the headers for each sample (the first line of each sample is a header)
val headers = data.map( {case (genome,label) =&gt; (genome.split(&quot;\n&quot;).head.split('|'),label)})
headers.count
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>headers: org.apache.spark.rdd.RDD[(Array[String], String)] = MapPartitionsRDD[35] at map at command-3103574048360661:1
res2: Long = 31550
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">headers.take(5)
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>res3: Array[(Array[String], String)] = Array((Array(&quot;MW320729.1 &quot;, Severe acute respiratory syndrome coronavirus 2 isolate SARS-CoV-2/human/AUS/VIC16982/2020, complete genome),oceania), (Array(&quot;MW320730.1 &quot;, Severe acute respiratory syndrome coronavirus 2 isolate SARS-CoV-2/human/AUS/VIC17307/2020, complete genome),oceania), (Array(&quot;MW320731.1 &quot;, Severe acute respiratory syndrome coronavirus 2 isolate SARS-CoV-2/human/AUS/VIC17193/2020, complete genome),oceania), (Array(&quot;MW320733.1 &quot;, Severe acute respiratory syndrome coronavirus 2 isolate SARS-CoV-2/human/AUS/VIC16732/2020, complete genome),oceania), (Array(&quot;MW320735.1 &quot;, Severe acute respiratory syndrome coronavirus 2 isolate SARS-CoV-2/human/AUS/VIC16821/2020, complete genome),oceania))
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">// remove the headers and only get genome sequences of samples.
val samples = data.map( {case (genome,label) =&gt; (genome.split(&quot;\n&quot;).tail.mkString(&quot;&quot;), label)}).cache()
samples.count
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>samples: org.apache.spark.rdd.RDD[(String, String)] = MapPartitionsRDD[202309] at map at command-3103574048360662:2
res0: Long = 31550
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">// get the genome lengths per sample (this is just to check if there are extreme cases so we would remove those)
val genome_length_per_s = samples.map({case (genome,label) =&gt; genome.length()})
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>genome_length_per_s: org.apache.spark.rdd.RDD[Int] = MapPartitionsRDD[14298] at map at command-3103574048360664:1
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">// check the statistics if there is any significant variation
genome_length_per_s.stats
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>res6: org.apache.spark.util.StatCounter = (count: 31550, mean: 29812.288621, stdev: 81.069114, max: 30018.000000, min: 28645.000000)
</code></pre>
</div>
</div>
<div class="cell markdown">
<h4 id="extract-overlapping-or-nonoverlapping-3-mers"><a class="header" href="#extract-overlapping-or-nonoverlapping-3-mers">Extract (overlapping or nonoverlapping) 3-mers</a></h4>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">// A tail recursive overlapping subsequence function 
// ex1: input: (&quot;abcd&quot;, 2, true) -&gt; output: &quot;ab bc cd&quot;: 
// ex2: input: (&quot;abcd&quot;, 2, false) -&gt; output: &quot;ab cd&quot;
def subsequence_str( sequence:String, k:Int, overlapping:Boolean ): String = {
  def helper(seq:String, acc:String): String = {
    if (seq.length &lt; k ) {
      return acc
    }
    else {
      val sub = seq.substring(0,k)
      if(overlapping) helper(seq.tail, acc + sub + &quot; &quot;)
      else helper(seq.substring(k), acc + sub + &quot; &quot;)
    }
  }
  return helper(sequence, &quot;&quot;)
}
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>subsequence_str: (sequence: String, k: Int, overlapping: Boolean)String
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">// Extract the subsequences, kmers, for each sample
val k_mers = samples.map( {case (genome,label) =&gt; (subsequence_str(genome, 3, false),label)} ).cache()
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>k_mers: org.apache.spark.rdd.RDD[(String, String)] = MapPartitionsRDD[202801] at map at command-3103574048360668:1
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">k_mers.take(1)
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">// index kmers
val kmers_df = k_mers.zipWithIndex.map({case ((a,b),c) =&gt; (a,b,c)}).toDF(&quot;genome&quot;, &quot;label&quot;, &quot;id&quot;).cache()
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>kmers_df: org.apache.spark.sql.Dataset[org.apache.spark.sql.Row] = [genome: string, label: string ... 1 more field]
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">kmers_df.take(1)
</code></pre>
</div>
<div class="cell markdown">
<h3 id="split-dataset-as-train-and-test"><a class="header" href="#split-dataset-as-train-and-test">Split dataset as train and test</a></h3>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">// split train and test data
val split = kmers_df.randomSplit(Array(0.7, 0.3), seed=42)
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>split: Array[org.apache.spark.sql.Dataset[org.apache.spark.sql.Row]] = Array([genome: string, label: string ... 1 more field], [genome: string, label: string ... 1 more field])
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">val train = split(0).cache()
train.take(1)
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">train.count
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>res6: Long = 22155
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">val test = split(1).cache()
test.take(1)
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">test.count
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>res9: Long = 9395
</code></pre>
</div>
</div>
<div class="cell markdown">
<h3 id="save-the-results"><a class="header" href="#save-the-results">Save the results</a></h3>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">// save the results for the next notebook
dbutils.fs.rm(&quot;/FileStore/shared_uploads/caylak@kth.se/data_test_nonoverlapping&quot;, recurse=true) // remove existing folder
test.write.parquet(&quot;dbfs:/FileStore/shared_uploads/caylak@kth.se/data_test_nonoverlapping&quot;)

dbutils.fs.rm(&quot;/FileStore/shared_uploads/caylak@kth.se/data_train_nonoverlapping&quot;, recurse=true) // remove existing folder
train.write.parquet(&quot;dbfs:/FileStore/shared_uploads/caylak@kth.se/data_train_nonoverlapping&quot;)
</code></pre>
</div>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../contents/student-project-09_group-TopicModeling/01_Introduction.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../../contents/student-project-09_group-TopicModeling/03_LDA.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../contents/student-project-09_group-TopicModeling/01_Introduction.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../../contents/student-project-09_group-TopicModeling/03_LDA.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
